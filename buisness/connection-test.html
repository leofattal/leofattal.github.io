<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Connection Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            line-height: 1.6;
        }
        .test-item {
            margin: 1rem 0;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .success {
            border-color: #27ae60;
            background: #d4edda;
            color: #155724;
        }
        .error {
            border-color: #e74c3c;
            background: #f8d7da;
            color: #721c24;
        }
        .warning {
            border-color: #f39c12;
            background: #fff3cd;
            color: #856404;
        }
        .loading {
            border-color: #3498db;
            background: #cce7ff;
            color: #004085;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            margin: 0.5rem 0.5rem 0.5rem 0;
        }
        button:hover {
            background: #2980b9;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 1rem;
            margin: 1rem 0;
            font-family: monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.5rem;
        }
        .status-online {
            background: #27ae60;
        }
        .status-offline {
            background: #e74c3c;
        }
        .status-loading {
            background: #f39c12;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <h1>üîß Supabase Connection Diagnostics</h1>
    <p>This page helps diagnose connection issues with your e-commerce website.</p>

    <div class="test-item loading" id="connectionStatus">
        <h3><span class="status-indicator status-loading"></span>Connection Status</h3>
        <p>Testing connection to Supabase...</p>
    </div>

    <div class="test-item" id="browserInfo">
        <h3>Browser Information</h3>
        <p><strong>User Agent:</strong> <span id="userAgent"></span></p>
        <p><strong>Online:</strong> <span id="onlineStatus"></span></p>
        <p><strong>HTTPS:</strong> <span id="httpsStatus"></span></p>
        <p><strong>Local Storage:</strong> <span id="localStorageStatus"></span></p>
    </div>

    <div class="test-item">
        <h3>Manual Tests</h3>
        <button onclick="testConnection()">Test Supabase Connection</button>
        <button onclick="testProducts()">Test Product Fetch</button>
        <button onclick="testAddProduct()">Test Add Product</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <div class="test-item">
        <h3>Test Log</h3>
        <div id="testLog" class="log">
            Ready to run tests...<br>
        </div>
    </div>

    <div class="test-item">
        <h3>Common Solutions</h3>
        <ul>
            <li><strong>Check Internet Connection:</strong> Make sure you're connected to the internet</li>
            <li><strong>HTTPS Required:</strong> Supabase requires HTTPS in production</li>
            <li><strong>CORS Issues:</strong> Check if your domain is allowed in Supabase settings</li>
            <li><strong>API Keys:</strong> Verify your Supabase URL and anon key are correct</li>
            <li><strong>Database Schema:</strong> Run the database schema setup in Supabase SQL Editor</li>
            <li><strong>Browser Cache:</strong> Try refreshing the page or clearing browser cache</li>
        </ul>
    </div>

    <script type="module">
        import { testSupabaseConnection, SupabaseECommerce } from './supabase.js';

        let logElement = document.getElementById('testLog');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : type === 'warning' ? 'orange' : 'black';
            logElement.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span><br>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        window.log = log;

        // Initialize browser info
        document.getElementById('userAgent').textContent = navigator.userAgent;
        document.getElementById('onlineStatus').textContent = navigator.onLine ? '‚úÖ Online' : '‚ùå Offline';
        document.getElementById('httpsStatus').textContent = location.protocol === 'https:' ? '‚úÖ HTTPS' : '‚ùå HTTP';
        
        try {
            localStorage.setItem('test', 'test');
            localStorage.removeItem('test');
            document.getElementById('localStorageStatus').textContent = '‚úÖ Available';
        } catch (e) {
            document.getElementById('localStorageStatus').textContent = '‚ùå Not Available';
        }

        // Test connection on load
        async function initialTest() {
            const statusElement = document.getElementById('connectionStatus');
            const indicator = statusElement.querySelector('.status-indicator');
            
            try {
                log('Starting initial connection test...');
                const isConnected = await testSupabaseConnection();
                
                if (isConnected) {
                    statusElement.className = 'test-item success';
                    indicator.className = 'status-indicator status-online';
                    statusElement.querySelector('p').textContent = 'Successfully connected to Supabase!';
                    log('‚úÖ Supabase connection successful', 'success');
                } else {
                    throw new Error('Connection test failed');
                }
            } catch (error) {
                statusElement.className = 'test-item error';
                indicator.className = 'status-indicator status-offline';
                statusElement.querySelector('p').textContent = 'Failed to connect to Supabase. See log for details.';
                log(`‚ùå Connection failed: ${error.message}`, 'error');
            }
        }

        // Test functions
        window.testConnection = async function() {
            try {
                log('Testing Supabase connection...');
                const result = await testSupabaseConnection();
                log(result ? '‚úÖ Connection successful' : '‚ùå Connection failed', result ? 'success' : 'error');
            } catch (error) {
                log(`‚ùå Connection error: ${error.message}`, 'error');
            }
        };

        window.testProducts = async function() {
            try {
                log('Testing product fetch...');
                const products = await SupabaseECommerce.getAllProducts();
                log(`‚úÖ Fetched ${products.length} products`, 'success');
                if (products.length > 0) {
                    log(`Sample product: ${products[0].name}`, 'info');
                }
            } catch (error) {
                log(`‚ùå Product fetch failed: ${error.message}`, 'error');
            }
        };

        window.testAddProduct = async function() {
            try {
                log('Testing add product...');
                const testProduct = {
                    name: 'Test Product ' + Date.now(),
                    price: 9.99,
                    description: 'Test product for connection testing',
                    image: 'https://via.placeholder.com/300x200?text=Test+Product',
                    stock_quantity: 10,
                    low_stock_alert: 2
                };
                
                const result = await SupabaseECommerce.addProduct(testProduct);
                log(`‚úÖ Product added successfully: ${result.name}`, 'success');
                
                // Clean up - delete the test product
                try {
                    await SupabaseECommerce.deleteProduct(result.id);
                    log('‚úÖ Test product cleaned up', 'success');
                } catch (cleanupError) {
                    log(`‚ö†Ô∏è Cleanup warning: ${cleanupError.message}`, 'warning');
                }
            } catch (error) {
                log(`‚ùå Add product failed: ${error.message}`, 'error');
            }
        };

        window.clearLog = function() {
            logElement.innerHTML = 'Log cleared...<br>';
        };

        // Run initial test
        initialTest();

        // Network status monitoring
        window.addEventListener('online', () => {
            log('üåê Network connection restored', 'success');
            document.getElementById('onlineStatus').textContent = '‚úÖ Online';
        });

        window.addEventListener('offline', () => {
            log('üö´ Network connection lost', 'error');
            document.getElementById('onlineStatus').textContent = '‚ùå Offline';
        });
    </script>
</body>
</html>